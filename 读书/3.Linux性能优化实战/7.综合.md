# 一个OOM的问题

> 工作中比较少

## 问题&工具

1. dmesg可以查看OOM信息

   ![image-20200712170242603](http://picgo.vipkk.work/20200712170248.png)

   可以得到

   1. 谁触发的oom
   2. 触发的limit
   3. kill的pid



# 服务器丢包的排查

![img](http://picgo.vipkk.work/20200712171955.png)

## 链路层检查

`netstat -i`

```shell
root@nginx:/# netstat -i
Kernel Interface table
Iface      MTU    RX-OK RX-ERR RX-DRP RX-OVR    TX-OK TX-ERR TX-DRP TX-OVR Flg
eth0       100       34      0      0 0            10      0      0      0 BMRU
lo       65536        0      0      0 0             0      0      0      0 LRU
```

输出中的 RX-OK、RX-ERR、RX-DRP、RX-OVR ，分别表示接收时的总包数、总错误数、进入 Ring Buffer 后因其他原因（如内存不足）导致的丢包数以及 Ring Buffer 溢出导致的丢包数。



可见此时，链路层没有问题。

## 网络层和传输层

`netstat -s`

```shell

root@nginx:/# netstat -s
Ip:
    Forwarding: 1          //开启转发
    31 total packets received    //总收包数
    0 forwarded            //转发包数
    0 incoming packets discarded  //接收丢包数
    25 incoming packets delivered  //接收的数据包数
    15 requests sent out      //发出的数据包数
Icmp:
    0 ICMP messages received    //收到的ICMP包数
    0 input ICMP message failed    //收到ICMP失败数
    ICMP input histogram:
    0 ICMP messages sent      //ICMP发送数
    0 ICMP messages failed      //ICMP失败数
    ICMP output histogram:
Tcp:
    0 active connection openings  //主动连接数
    0 passive connection openings  //被动连接数
    11 failed connection attempts  //失败连接尝试数
    0 connection resets received  //接收的连接重置数
    0 connections established    //建立连接数
    25 segments received      //已接收报文数
    21 segments sent out      //已发送报文数
    4 segments retransmitted    //重传报文数
    0 bad segments received      //错误报文数
    0 resets sent          //发出的连接重置数
Udp:
    0 packets received
    ...
TcpExt:
    11 resets received for embryonic SYN_RECV sockets  //半连接重置数
    0 packet headers predicted
    TCPTimeouts: 7    //超时数
    TCPSynRetrans: 4  //SYN重传数
  ...
```

> netstat 汇总了IP、ICMP、TCP、UDP等各种协议的收发统计信息。

由上，可以看到，TCP协议发生了丢包和重传

- 11 次连接失败重试（11 failed connection attempts）
- 4 次重传（4 segments retransmitted）
- 11 次半连接重置（11 resets received for embryonic SYN_RECV sockets）
- 4 次 SYN 重传（TCPSynRetrans）
- 7 次超时（TCPTimeouts）

主要是半连接重置，换句话说，主要是握手失败。



### iptables[^1]

> iptables 的原理，它基于 Netfilter 框架，通过一系列的规则，对网络数据包进行过滤（如防火墙）和修改（如 NAT）。

查看filters

![image-20200712173718893](http://picgo.vipkk.work/20200712173718.png)

可见当前对 input 和output都进行了30%的丢包

执行删除

```
root@nginx:/# iptables -t filter -D INPUT -m statistic --mode random --probability 0.30 -j DROP
root@nginx:/# iptables -t filter -D OUTPUT -m statistic --mode random --probability 0.30 -j DROP
```

再次查看

![image-20200712173922107](http://picgo.vipkk.work/20200712173922.png)

验证

```
➜  ~ hping3 -c 10 -S -p 80 hw01
HPING hw01 (eth0 192.168.12.1): S set, 40 headers + 0 data bytes
len=44 ip=192.168.12.1 ttl=63 DF id=0 sport=80 flags=SA seq=0 win=65535 rtt=1.5 ms
len=44 ip=192.168.12.1 ttl=63 DF id=0 sport=80 flags=SA seq=1 win=65535 rtt=1.5 ms
len=44 ip=192.168.12.1 ttl=63 DF id=0 sport=80 flags=SA seq=2 win=65535 rtt=1.5 ms
len=44 ip=192.168.12.1 ttl=63 DF id=0 sport=80 flags=SA seq=3 win=65535 rtt=1.4 ms
len=44 ip=192.168.12.1 ttl=63 DF id=0 sport=80 flags=SA seq=4 win=65535 rtt=1.4 ms
len=44 ip=192.168.12.1 ttl=63 DF id=0 sport=80 flags=SA seq=5 win=65535 rtt=1.4 ms
len=44 ip=192.168.12.1 ttl=63 DF id=0 sport=80 flags=SA seq=6 win=65535 rtt=1.5 ms
len=44 ip=192.168.12.1 ttl=63 DF id=0 sport=80 flags=SA seq=7 win=65535 rtt=1.4 ms
len=44 ip=192.168.12.1 ttl=63 DF id=0 sport=80 flags=SA seq=8 win=65535 rtt=1.4 ms
len=44 ip=192.168.12.1 ttl=63 DF id=0 sport=80 flags=SA seq=9 win=65535 rtt=1.4 ms

--- hw01 hping statistic ---
10 packets transmitted, 10 packets received, 0% packet loss
round-trip min/avg/max = 1.4/1.4/1.5 ms
```

TODO:

验证

![image-20200712174603192](http://picgo.vipkk.work/20200712174603.png)







[^1]: https://man7.org/linux/man-pages/man8/iptables.8.html